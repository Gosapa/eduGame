{% extends 'base.html' %}
{% block body %}
<div id="loading" class="flex flex-col items-center justify-center h-full p-4">
    {{ achievement | json_script:"achievement_data" }}
    <h1 class="text-3xl font-bold text-gray-800 mb-4">END OF GAME</h1>

    <div class="bg-white rounded-md shadow-md p-8 w-full max-w-lg">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Score</h2>
        <p class="text-lg font-medium text-gray-700">SCORE: {{ game.score }}/10</p>
        <div class="flex justify-center space-x-2 mt-3">
            {% for question in game.grade %}
                {% if question == 1 %}
                <div class="bg-green-400 text-gray-800 font-medium py-2 px-3 rounded-md">
                    {{ forloop.counter }}
                </div>
                {% else %}
                <div class="bg-red-400 text-gray-800 font-medium py-2 px-3 rounded-md">
                    {{ forloop.counter }}
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mb-4 mt-8">Achievement Unlocked!</h2>
        <div class="flex flex-row justify-between">
            <p class="text-lg font-medium text-gray-700">{{ achievement.name }}</p>
            <button id="send_achievement" class="bg-blue-500 hover:bg-blue-700 text-white text-xs py-1 px-3 rounded focus:outline-none focus:shadow-outline" onclick="save_achievement()">Save Achievement</button>
        </div>

        <p class="text-gray-700 my-2">{{ achievement.description }}</p>

        <div class="flex justify-around mt-8">
            <a href="{% url 'game:play_game' game_id=game.id %}" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Play Again</a>
            <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-md focus:outline-none focus:shadow-outline" onclick="deleteGame()">
                Delete Game
            </button>
        </div>
        
    </div>
</div>
{% endblock body %}
{% block script %}
<script>
    async function save_achievement(){
        const endpointURL = "{% url 'users:save_achievement' %}";
        const achievementData = JSON.parse(document.getElementById('achievement_data').textContent);
        try {
            const response = await fetch (endpointURL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify(achievementData),
            });
            if (response.ok) {
                const data = await response.json();
                console.log(data);
                alert("Achievement saved successfully!"); 
                document.getElementById('send_achievement').disabled=true;
            }else {
                console.error("Error saving achievement", response.status);
                console.log(response);
            }
        } catch (error) {
            console.error("Error occurred", error);
        }
    }
    async function deleteGame() {
        const gameId = window.location.pathname.split('/')[3]; 
        console.log(gameId)
        const endpointURL = `{% url 'game:delete' %}?game_id=${gameId}`;

        if (confirm("Are you sure you want to delete this game? You can't revert this action.")) {
            try {
                const response = await fetch(endpointURL, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                });
                if (response.ok) {
                    window.location.href = "{% url 'game:list' %}"; 
                    alert("Game deleted successfully!");
                } else {
                    console.error("Error deleting game:", response.status);
                    console.log(response);
                }
            } catch (error) {
                console.error("Error occurred:", error);
            }
        }
    }
</script>
{% endblock script %}